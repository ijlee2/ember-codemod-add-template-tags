import {
  assertFixture,
  loadFixture,
  normalizeFile,
  test,
} from '@codemod-utils/tests';

import { findEntities, updateTests } from '../../../src/steps/index.js';
import {
  inputProject,
  options,
  packages,
} from '../../helpers/shared-test-setups/my-v2-app.js';

test('steps | update-tests > v2-app', function () {
  const outputProject = {
    app: {
      components: {
        ui: {
          form: {
            'checkbox.hbs': ``,
            'checkbox.ts': normalizeFile([
              `import Component from '@glimmer/component';`,
              ``,
              `interface UiFormCheckboxSignature {}`,
              ``,
              `export default class UiFormCheckbox extends Component<UiFormCheckboxSignature> {}`,
              ``,
              `declare module '@glint/environment-ember-loose/registry' {`,
              `  export default interface Registry {`,
              `    'Ui::Form::Checkbox': typeof UiFormCheckbox;`,
              `    'ui/form/checkbox': typeof UiFormCheckbox;`,
              `  }`,
              `}`,
              ``,
            ]),
            'field.hbs': ``,
            'field.ts': normalizeFile([
              `import Component from '@glimmer/component';`,
              ``,
              `interface UiFormFieldSignature {}`,
              ``,
              `export default class UiFormField extends Component<UiFormFieldSignature> {}`,
              ``,
            ]),
            'information.hbs': ``,
            'information.ts': normalizeFile([
              `import templateOnlyComponent from '@ember/component/template-only';`,
              ``,
              `interface UiFormInformationSignature {}`,
              ``,
              `const UiFormInformation = templateOnlyComponent<UiFormInformationSignature>();`,
              ``,
              `export default UiFormInformation;`,
              ``,
              `declare module '@glint/environment-ember-loose/registry' {`,
              `  export default interface Registry {`,
              `    'Ui::Form::Information': typeof UiFormInformation;`,
              `    'ui/form/information': typeof UiFormInformation;`,
              `  }`,
              `}`,
              ``,
            ]),
            'input.hbs': ``,
            'input.js': normalizeFile([
              `import Component from '@glimmer/component';`,
              ``,
              `export default class UiFormInput extends Component {}`,
              ``,
            ]),
            'number.gts': ``,
            'select.hbs': ``,
            'select.ts': normalizeFile([
              `import Component from '@glimmer/component';`,
              ``,
              `interface UiFormSelectSignature {}`,
              ``,
              `export default class UiFormSelect extends Component<UiFormSelectSignature> {}`,
              ``,
            ]),
            'textarea.gjs': ``,
          },
          'form.hbs': ``,
          'form.ts': normalizeFile([
            `import Component from '@glimmer/component';`,
            ``,
            `interface UiFormSignature {}`,
            ``,
            `export default class UiForm extends Component<UiFormSignature> {}`,
            ``,
          ]),
          'page.hbs': ``,
          'page.js': normalizeFile([
            `import templateOnlyComponent from '@ember/component/template-only';`,
            ``,
            `const UiPage = templateOnlyComponent();`,
            ``,
            `export default UiPage;`,
            ``,
          ]),
        },
        'navigation-menu.hbs': '',
        'select-locale.hbs': '',
        'select-locale.js': normalizeFile([
          `import Component from '@glimmer/component';`,
          ``,
          `export default class SelectLocale extends Component {}`,
          ``,
        ]),
      },
      templates: {
        'application.hbs': normalizeFile([
          `<header>`,
          `  <NavigationMenu />`,
          `</header>`,
          ``,
          `<main>`,
          `  {{outlet}}`,
          `</main>`,
        ]),
        'index.hbs': `<SelectLocale />`,
      },
    },
    tests: {
      integration: {
        components: {
          ui: {
            form: {
              'checkbox-test.gts': normalizeFile([
                `import UiFormCheckbox from 'my-v2-app/components/ui/form/checkbox';`,
                ``,
                `import {`,
                `  render,`,
                `  type TestContext as BaseTestContext,`,
                `} from '@ember/test-helpers';`,
                `import { UiForm } from 'my-addon/test-support';`,
                `import { setupRenderingTest } from 'my-v2-app/tests/helpers';`,
                `import { module, test } from 'qunit';`,
                ``,
                `interface TestContext extends BaseTestContext {`,
                `  parent: UiForm;`,
                `}`,
                ``,
                `module('Integration | Component | ui/form/checkbox', function (hooks) {`,
                `  setupRenderingTest(hooks);`,
                ``,
                `  hooks.beforeEach(function (this: TestContext) {`,
                `    this.parent = new UiForm();`,
                `  });`,
                ``,
                `  test('it renders', async function (this: TestContext, assert) {`,
                `    const self = this;`,
                ``,
                ``,
                ``,
                ``,
                `    await render(<template><UiFormCheckbox`,
                `    @data={{self.parent.data}}`,
                `    @key="subscribe"`,
                `    @label="Subscribe to The Ember Times?"`,
                `    @onUpdate={{self.parent.updateData}}`,
                `    /></template>);`,
                ``,
                `    assert.ok(true);`,
                `  });`,
                `});`,
                ``,
              ]),
              'field-test.gts': '',
              'information-test.gts': '',
              'input-test.gjs': '',
              'number-test.gts': '',
              'select-test.gts': '',
              'textarea-test.gjs': normalizeFile([
                `import UiFormTextarea from 'my-v2-app/components/ui/form/textarea';`,
                ``,
                `import { render } from '@ember/test-helpers';`,
                `import { setupRenderingTest } from 'my-v2-app/tests/helpers';`,
                `import { module, test } from 'qunit';`,
                ``,
                `module('Integration | Component | ui/form/textarea', function (hooks) {`,
                `  setupRenderingTest(hooks);`,
                ``,
                `  hooks.beforeEach(function () {`,
                `    this.data = {`,
                `      email: 'zoey@emberjs.com',`,
                `      message: 'I ðŸ§¡ container queries!',`,
                `      name: 'Zoey',`,
                `      subscribe: false,`,
                `    };`,
                ``,
                `    this.updateData = () => {`,
                `      // Do nothing`,
                `    };`,
                `  });`,
                ``,
                `  test('it renders', async function (assert) {`,
                `    const self = this;`,
                ``,
                ``,
                ``,
                ``,
                `    await render(<template><UiFormTextarea`,
                `    @data={{self.data}}`,
                `    @key="message"`,
                `    @label="Message"`,
                `    @onUpdate={{self.updateData}}`,
                `    /></template>);`,
                ``,
                `    assert.ok(true);`,
                `  });`,
                `});`,
                ``,
              ]),
            },
            'form-test.gts': '',
            'page-test.gjs': '',
          },
          'navigation-menu-test.gjs': '',
          'select-locale-test.gjs': '',
        },
      },
    },
    'package.json': JSON.stringify({
      name: 'my-v2-app',
      version: '1.0.0',
      devDependencies: {
        '@embroider/vite': '^1.2.0',
        'ember-source': '~6.7.0',
      },
    }),
  };

  loadFixture(inputProject, options);

  const entities = findEntities(options);

  updateTests(packages, entities);

  assertFixture(outputProject, options);
});
